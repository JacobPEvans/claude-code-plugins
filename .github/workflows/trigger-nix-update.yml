name: Trigger Nix Flake Update

on:
  push:
    branches:
      - main
  # Also trigger on successful PR merges
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  trigger-nix:
    # Only run on push to main OR on merged PRs
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Minimal permissions

    steps:
      - name: Trigger nix repository flake update
        run: |
          gh api repos/JacobPEvans/nix/dispatches \
            --method POST \
            --field event_type='upstream-repo-updated' \
            --field client_payload[flake_input_name]='claude-code-plugins' \
            --field client_payload[source_repo]="$SOURCE_REPO" \
            --field client_payload[source_ref]="$SOURCE_REF" \
            --field client_payload[commit_sha]="$COMMIT_SHA"
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_DISPATCH_PAT }}
          SOURCE_REPO: ${{ github.repository }}
          SOURCE_REF: ${{ github.ref }}
          COMMIT_SHA: ${{ github.sha }}

      - name: Log dispatch
        run: |
          echo "âœ… Triggered nix flake update workflow"
          echo "Source: $SOURCE_REPO"
          echo "Commit: $COMMIT_SHA"
        env:
          SOURCE_REPO: ${{ github.repository }}
          COMMIT_SHA: ${{ github.sha }}
